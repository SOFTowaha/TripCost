name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: macos-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Show Xcode version
      run: xcodebuild -version
      
    - name: Validate project file
      run: |
        if [ ! -f "TripCost.xcodeproj/project.pbxproj" ]; then
          echo "Error: project.pbxproj not found!"
          exit 1
        fi
        echo "Project file exists and is readable"
        
    - name: List schemes
      run: xcodebuild -list -project TripCost.xcodeproj
      
    - name: Build archive
      run: |
        xcodebuild archive \
          -project TripCost.xcodeproj \
          -scheme TripCost \
          -archivePath ./build/TripCost.xcarchive \
          -destination 'platform=macOS' \
          -configuration Release \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          ONLY_ACTIVE_ARCH=NO
          
    - name: Export app
      run: |
        xcodebuild -exportArchive \
          -archivePath ./build/TripCost.xcarchive \
          -exportPath ./build/export \
          -exportOptionsPlist ExportOptions.plist || \
        cp -R ./build/TripCost.xcarchive/Products/Applications/TripCost.app ./build/export/
        
    - name: Create DMG
      run: |
        mkdir -p ./build/dmg
        cp -R ./build/export/TripCost.app ./build/dmg/
        hdiutil create -volname "TripCost" \
          -srcfolder ./build/dmg \
          -ov -format UDZO \
          ./build/TripCost-${{ github.ref_name }}.dmg
          
    - name: Create ZIP
      run: |
        cd ./build/export
        zip -r ../TripCost-${{ github.ref_name }}.zip TripCost.app
        cd ../..
        
    - name: Generate Release Notes
      id: release_notes
      run: |
        echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
        echo "## TripCost ${{ github.ref_name }}" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### 🎉 What's New" >> $GITHUB_OUTPUT
        echo "- 💾 **Saved Trips**: Save and manage your trip history with full route details, costs, and vehicle info" >> $GITHUB_OUTPUT
        echo "- ✏️ **Edit Saved Trips**: Modify number of people splitting costs with live cost-per-person updates" >> $GITHUB_OUTPUT
        echo "- 📍 **Smart Location Names**: Automatically capture real place names from map selections" >> $GITHUB_OUTPUT
        echo "- 📤 **Share Trips**: Share your saved trip details with friends" >> $GITHUB_OUTPUT
        echo "- ⛽ **Fuel Cost Display**: View detailed fuel costs in saved trip summaries" >> $GITHUB_OUTPUT
        echo "- 🏷️ **Auto Trip Names**: Trips automatically named as 'Start → Destination'" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### 🐛 Bug Fixes" >> $GITHUB_OUTPUT
        echo "- Fixed MapKit coordinate access for proper location handling" >> $GITHUB_OUTPUT
        echo "- Fixed address persistence issues (no more disappearing location names)" >> $GITHUB_OUTPUT
        echo "- Universal binary support for both Intel and Apple Silicon Macs" >> $GITHUB_OUTPUT
        echo "- Resolved Swift 6 actor isolation warnings" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ✨ Enhancements" >> $GITHUB_OUTPUT
        echo "- Glass-themed UI for saved trip detail pages" >> $GITHUB_OUTPUT
        echo "- Improved async/await handling for location services" >> $GITHUB_OUTPUT
        echo "- Better type-checking performance" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### Installation" >> $GITHUB_OUTPUT
        echo "1. Download the DMG or ZIP file below" >> $GITHUB_OUTPUT
        echo "2. Open DMG and drag TripCost to Applications (or extract ZIP)" >> $GITHUB_OUTPUT
        echo "3. Launch TripCost from Applications" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### Requirements" >> $GITHUB_OUTPUT
        echo "- macOS 14.0 (Sonoma) or later" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### 📖 Full Changelog" >> $GITHUB_OUTPUT
        echo "See [CHANGELOG.md](https://github.com/SOFTowaha/TripCost/blob/main/CHANGELOG.md) for complete version history" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./build/TripCost-${{ github.ref_name }}.dmg
          ./build/TripCost-${{ github.ref_name }}.zip
        body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
